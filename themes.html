<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Template Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

<!-- Admin Header -->
<header id="admin-header" class="bg-blue-600 text-white p-6">
    <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-3xl font-bold">Admin Dashboard</h1>
        <nav class="space-x-6">
            <button class="bg-green-500 px-4 py-2 rounded" onclick="openCreateCategoryPopup()">Create Category</button>
            <button class="bg-blue-500 px-4 py-2 rounded" onclick="returnToHome()">Return to Home</button>
        </nav>
    </div>
</header>

<!-- Business Category Page -->
<div id="category-page" class="p-10">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-800">Choose a Business Category</h1>
    </header>

    <section class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-6" id="category-container"></section>
</div>

<!-- Template Selection Page -->
<div id="template-page" class="p-10 hidden">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-800">Choose a Template for <span id="category-name"></span></h1>
    </header>

    <button class="bg-green-500 text-white px-4 py-2 rounded mb-4" onclick="openCreateThemePopup()">Create New Theme</button>
    <button class="bg-blue-500 text-white px-4 py-2 rounded mb-4" onclick="returnToHome()">Return to Home</button>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="template-container"></section>
</div>

<!-- Preview Page -->
<div id="preview-page" class="hidden">
    <header class="bg-gray-800 text-white py-4 flex justify-between items-center">
        <div>
            <button class="bg-blue-500 px-4 py-2 rounded" onclick="returnToHome()">Return to Home</button>
        </div>
        <div id="nav-pages" class="flex space-x-4"></div>
        <div>
            <button class="bg-yellow-500 px-4 py-2 rounded" onclick="createPage()">Create Page</button>
            <button class="bg-red-500 px-4 py-2 rounded ml-2" onclick="deletePage()">Delete Page</button>
            <button class="bg-blue-500 px-4 py-2 rounded ml-4" onclick="editHtml()">Edit HTML</button>
            <button class="bg-green-500 px-4 py-2 rounded ml-4" onclick="saveAllPages()">Save All Pages</button>
        </div>
    </header>
    <iframe id="preview-frame" class="w-full h-screen" srcdoc=""></iframe>
</div>

<!-- Full-Page Create Theme Popup -->
<div id="create-theme-popup" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
    <div class="bg-white p-10 rounded-lg shadow-lg w-full max-w-3xl">
        <h2 class="text-2xl font-bold mb-6">Create New Theme</h2>
        <form id="create-theme-form" onsubmit="createTheme(event)">
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Theme Name</label>
                <input type="text" id="theme-name" class="w-full p-3 border rounded" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Theme Price</label>
                <input type="text" id="theme-price" class="w-full p-3 border rounded" required>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Theme Image URL</label>
                <input type="text" id="theme-image" class="w-full p-3 border rounded" required>
            </div>
            <div class="flex justify-between">
                <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Create Theme</button>
                <button type="button" class="bg-red-500 text-white px-4 py-2 rounded" onclick="closeCreateThemePopup()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Full-Page Create Category Popup -->
<div id="create-category-popup" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
    <div class="bg-white p-10 rounded-lg shadow-lg w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6">Create New Category</h2>
        <form id="create-category-form" onsubmit="createCategory(event)">
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Category Name</label>
                <input type="text" id="category-name-input" class="w-full p-3 border rounded" required>
            </div>
            <div class="flex justify-between">
                <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Create Category</button>
                <button type="button" class="bg-red-500 text-white px-4 py-2 rounded" onclick="closeCreateCategoryPopup()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- HTML Editor Popup -->
<div id="popup" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded shadow-lg w-3/4">
        <h2 class="text-xl font-bold mb-4">HTML Editor</h2>
        <textarea id="html-display" class="w-full h-64 p-4 border border-gray-300 rounded mb-4 overflow-auto"></textarea>
        <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="saveHTML()">Save Changes</button>
        <button class="bg-red-500 text-white px-4 py-2 rounded ml-4" onclick="closePopup()">Close</button>
    </div>
</div>

<script>
    const templates = JSON.parse(localStorage.getItem('templates')) || {};
    const categories = JSON.parse(localStorage.getItem('categories')) || ['restaurant', 'donations', 'ecommerce'];
    let currentCategory = '';
    let currentPages = [];
    let currentPage = '';
    let currentThemeKey = '';
    let currentTemplate = null;

    function openCreateThemePopup() {
        document.getElementById('create-theme-popup').classList.remove('hidden');
    }

    function closeCreateThemePopup() {
        document.getElementById('create-theme-popup').classList.add('hidden');
    }

    async function createTheme(event) {
    event.preventDefault();
    const name = document.getElementById('theme-name').value;
    const price = document.getElementById('theme-price').value;
    const image = document.getElementById('theme-image').value;

    // Initialize theme with a default Home page
    const defaultPages = [
        { name: 'Home', html: '<h1>Welcome to the Home Page</h1>' } // Default HTML for Home page
    ];

    const response = await fetch('http://localhost:5000/api/theme', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ category: currentCategory, name, price, image, pages: defaultPages }),
    });

    if (response.ok) {
        alert('Theme created successfully!');
        closeCreateThemePopup();
        loadTemplatesForCategory(currentCategory);
    } else {
        alert('Failed to create theme.');
    }
}

    function openCreateCategoryPopup() {
        document.getElementById('create-category-popup').classList.remove('hidden');
    }

    function closeCreateCategoryPopup() {
        document.getElementById('create-category-popup').classList.add('hidden');
    }

    async function createCategory(event) {
        event.preventDefault();
        const categoryName = document.getElementById('category-name-input').value.toLowerCase();

        const response = await fetch('http://localhost:5000/api/category', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: categoryName }),
        });

        if (response.ok) {
            alert('Category created successfully!');
            closeCreateCategoryPopup();
            loadCategories();
        } else {
            alert('Failed to create category.');
        }
    }

    async function deleteCategory(categoryId) {
        const confirmDelete = confirm('Are you sure you want to delete this category?');
        if (!confirmDelete) return;

        const response = await fetch(`http://localhost:5000/api/category/${categoryId}`, {
            method: 'DELETE',
        });

        if (response.ok) {
            alert('Category deleted successfully!');
            loadCategories();
        } else {
            alert('Failed to delete category.');
        }
    }

    async function loadCategories() {
        const response = await fetch('http://localhost:5000/api/categories');
        const categories = await response.json();

        const container = document.getElementById('category-container');
        container.innerHTML = '';
        categories.forEach(category => {
            container.innerHTML += `
                <div class="bg-white p-8 shadow-lg rounded-lg text-center">
                    <h2 class="text-xl font-semibold mb-4">${category.name}</h2>
                    <button class="bg-green-500 text-white px-4 py-2 rounded" onclick="viewCategory('${category.name}')">View Category</button>
                    <button class="bg-red-500 text-white px-4 py-2 rounded mt-2" onclick="deleteCategory('${category._id}')">Delete Category</button>
                </div>
            `;
        });
    }

    function viewCategory(category) {
        currentCategory = category;
        document.getElementById('category-page').classList.add('hidden');
        document.getElementById('template-page').classList.remove('hidden');
        document.getElementById('category-name').textContent = category.charAt(0).toUpperCase() + category.slice(1);
        loadTemplatesForCategory(category);
    }

    async function loadTemplatesForCategory(category) {
    const response = await fetch(`http://localhost:5000/api/themes/${category}`);
    const templates = await response.json();

    const container = document.getElementById('template-container');
    container.innerHTML = '';
    templates.forEach(template => {
        container.innerHTML += `
            <div class="bg-white p-6 shadow-lg rounded-lg text-center">
                <h3 class="text-xl font-semibold mb-4">${template.name}</h3>
                <p class="text-gray-500 mb-2">Price: ${template.price}</p>
                <img src="${template.image}" alt="${template.name}" class="w-full h-40 object-cover mb-4">
                <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="previewTemplate('${template._id}')">Preview</button>
                <button class="bg-purple-500 text-white px-4 py-2 rounded mt-2" onclick="scheduleCustomization('${template._id}')">Schedule for Customization</button>
            </div>
        `;
    });
}

    async function previewTemplate(themeId) {
    const response = await fetch(`http://localhost:5000/api/theme/${themeId}`);
    const theme = await response.json();

    if (theme) {
        currentThemeKey = themeId;
        // Fetch the latest pages from the server to ensure sync
        currentPages = theme.pages.length ? theme.pages : [{ name: 'Home', html: '<h1>Welcome to this Theme</h1>' }];

        // Ensure the "Home" page always exists
        const homePage = currentPages.find(p => p.name === 'Home');
        if (!homePage) {
            currentPages.push({ name: 'Home', html: '<h1>Welcome to this Theme</h1>' });
        }

        // Load the "Home" page by default when viewing the theme
        loadPage('Home');
        renderNavigation();
        
        document.getElementById('admin-header').classList.add('hidden');
        document.getElementById('template-page').classList.add('hidden');
        document.getElementById('preview-page').classList.remove('hidden');
    } else {
        alert('Failed to load theme preview.');
    }
}

function loadPage(pageName) {
    const page = currentPages.find((p) => p.name === pageName);
    if (page) {
        currentPage = pageName;
        document.getElementById('preview-frame').srcdoc = page.html;
    } else if (pageName === 'Home') {
        // If Home is not found, initialize it with default content
        alert('Page "Home" not found. Initializing Home page.');
        loadPage('Home');
    } else {
        alert(`Page "${pageName}" not found. Loading "Home" page.`);
        loadPage('Home');  // Fallback to Home page if requested page is not found
    }
}

function renderNavigation() {
    const nav = document.getElementById('nav-pages');
    nav.innerHTML = '';
    currentPages.forEach(page => {
        nav.innerHTML += `<button class="bg-gray-500 text-white px-4 py-2 mr-2" onclick="loadPage('${page.name}')">${page.name}</button>`;
    });
}

    async function createPage() {
    const pageName = prompt('Enter the new page name:').trim();
    if (pageName && !currentPages.some((p) => p.name === pageName)) {
        const newPage = { name: pageName, html: `<h1>${pageName} Page</h1>` };
        try {
            const response = await fetch(`http://localhost:5000/api/theme/${currentThemeKey}/pages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newPage),
            });

            if (response.ok) {
                currentPages.push(newPage); // Add to local state
                renderNavigation();
                loadPage(pageName); // Load the new page
                alert('Page created successfully!');
            } else {
                alert('Failed to create page.');
            }
        } catch (error) {
            console.error('Error creating page:', error);
            alert('An error occurred while creating the page.');
        }
    } else {
        alert('Invalid page name or page already exists.');
    }
}

async function deletePage() {
    if (currentPage !== 'Home') {
        const confirmDelete = confirm(`Are you sure you want to delete the page: ${currentPage}?`);
        if (!confirmDelete) return;

        // Remove the page locally from the currentPages array
        currentPages = currentPages.filter(p => p.name !== currentPage);

        // Update the navigation bar
        renderNavigation();

        // Load the "Home" page after deleting
        loadPage('Home'); // Ensure "Home" is loaded after deletion
        currentPage = 'Home';  // Reset currentPage to "Home"

        // Send the DELETE request to the backend
        const response = await fetch(`http://localhost:5000/api/theme/${currentThemeKey}/pages/${currentPage}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
            alert(`Page "${currentPage}" deleted successfully.`);
        } else {
            alert('Failed to delete the page.');
        }
    } else {
        alert('Cannot delete the Home page.');
    }
}


    function editHtml() {
        const page = currentPages.find(p => p.name === currentPage);
        document.getElementById('popup').classList.remove('hidden');
        document.getElementById('html-display').value = page.html;
    }

    async function saveHTML() {
    const updatedHTML = document.getElementById('html-display').value;

    // Find and update the page locally
    const page = currentPages.find((p) => p.name === currentPage);
    if (page) {
        page.html = updatedHTML;

        // Ensure currentThemeKey is correctly set before making the PUT request
        if (currentThemeKey) {
            const response = await fetch(`http://localhost:5000/api/theme/${currentThemeKey}/page`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pageName: currentPage, html: updatedHTML }), // Send page name and updated HTML
            });

            if (response.ok) {
                document.getElementById('preview-frame').srcdoc = updatedHTML;  // Update the iframe preview
                alert('Page saved successfully!');
            } else {
                const errorMessage = await response.json();
                alert(`Failed to save page. ${errorMessage.error}`);
            }
        } else {
            alert('Theme ID (currentThemeKey) not set.');
        }
    } else {
        alert('Page not found.');
    }

    closePopup();  // Close the popup after saving
}

    async function saveAllPages() {
        const response = await fetch(`http://localhost:5000/api/theme/${currentThemeKey}/pages`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pages: currentPages }),
        });

        if (response.ok) {
            alert('All pages saved successfully!');
        } else {
            alert('Failed to save all pages.');
        }
    }

    function closePopup() {
        document.getElementById('popup').classList.add('hidden');
    }

    function returnToHome() {
        document.getElementById('admin-header').classList.remove('hidden');
        document.getElementById('category-page').classList.remove('hidden');
        document.getElementById('template-page').classList.add('hidden');
        document.getElementById('preview-page').classList.add('hidden');
    }

    window.onload = loadCategories;

    function scheduleCustomization(templateId) {
    window.location.href = `schedule.html?template=${templateId}`;
}
</script>

</body>
</html>